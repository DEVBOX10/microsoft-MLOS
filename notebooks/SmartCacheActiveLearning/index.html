<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Download notebook Goal The goal of this notebook is to optimize SmartCache using the Active Learning approach.
We define active learning as an approach when we execute the following loop:
 Get suggested config from optimizer, Apply suggested config to SmartCache, Execute a fixed workload, Collect the metrics from smart cache, Register an observation with the optimizer.  This is different from online learning in that the workload is fixed. In an online learning situation the workload could fluctuate, and we would pick up the changing workload signatures.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="" />
<meta property="og:description" content="Download notebook Goal The goal of this notebook is to optimize SmartCache using the Active Learning approach.
We define active learning as an approach when we execute the following loop:
 Get suggested config from optimizer, Apply suggested config to SmartCache, Execute a fixed workload, Collect the metrics from smart cache, Register an observation with the optimizer.  This is different from online learning in that the workload is fixed. In an online learning situation the workload could fluctuate, and we would pick up the changing workload signatures." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://microsoft.github.io/MLOS/notebooks/SmartCacheActiveLearning/" />

<title>Smart Cache Active Learning | MLOS</title>
<link rel="manifest" href="/MLOS/manifest.json">
<link rel="icon" href="/MLOS/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/MLOS/book.min.6cd8553a6854f4812343f0f0c8baca31271e686434f381fbe3c7226f66639176.css" integrity="sha256-bNhVOmhU9IEjQ/DwyLrKMSceaGQ084H748cib2ZjkXY=">
<script defer src="/MLOS/en.search.min.3243dd0460b1806e9d6a94c12a9fa4b6383a94e857afb6eabdcdb1fead6fd2aa.js" integrity="sha256-MkPdBGCxgG6dapTBKp&#43;ktjg6lOhXr7bqvc2x/q1v0qo="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir=>
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/MLOS"><span>MLOS</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  <ul>
<li>
<p><a href="/MLOS/documentation/">Documentation</a></p>
<ul>
<li><a href="/MLOS/documentation/01-Prerequisites/">Prerequisits</a></li>
<li><a href="/MLOS/documentation/02-Build/">Build</a></li>
<li><a href="/MLOS/documentation/05-Test/">Test</a></li>
<li><a href="/MLOS/documentation/CodingStandard/">Coding Standard</a></li>
<li><a href="/MLOS/documentation/MlosArchitecture/">Architecture</a></li>
<li><a href="/MLOS/documentation/RepoOrganization/">Repo Organization</a></li>
</ul>
</li>
<li>
<p>Notebooks</p>
<ul>
<li><a href="/MLOS/notebooks/StartHere/">Start Here</a></li>
<li><a href="/MLOS/notebooks/SmartCache/">Smart Cache</a></li>
<li><a href="/MLOS/notebooks/SmartCacheActiveLearning/"class=active>Smart Cache Active Learning</a></li>
<li><a href="/MLOS/notebooks/OptimizerMonitor/">Optimizer Monitor</a></li>
<li><a href="/MLOS/notebooks/BayesianOptimization/">Bayesian Optimization</a></li>
</ul>
</li>
<li>
<p>API Documentation</p>
<ul>
<li><a href="/MLOS/python_api/">Python</a></li>
</ul>
</li>
<li>
<p><a href="/MLOS/CODE_OF_CONDUCT/">Code of Conduct</a></p>
</li>
<li>
<p><a href="/MLOS/CONTRIBUTING/">Contributing</a></p>
</li>
</ul>










</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/MLOS/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Smart Cache Active Learning</strong>

  <label for="toc-control">
    
    <img src="/MLOS/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  <nav id="TableOfContents"></nav>


  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="download-notebookhttpsrawgithubusercontentcommicrosoftmlosmainsourcemlosnotebookssmartcacheactivelearningipynb"><a href="https://raw.githubusercontent.com/microsoft/MLOS/main/source/Mlos.Notebooks/SmartCacheActiveLearning.ipynb">Download notebook</a></h1>
<h1 id="goal">Goal</h1>
<p>The goal of this notebook is to optimize SmartCache using the Active Learning approach.</p>
<p>We define active learning as an approach when we execute the following loop:</p>
<ol>
<li>Get suggested config from optimizer,</li>
<li>Apply suggested config to SmartCache,</li>
<li>Execute a fixed workload,</li>
<li>Collect the metrics from smart cache,</li>
<li>Register an observation with the optimizer.</li>
</ol>
<p>This is different from online learning in that the workload is fixed. In an online learning situation the workload could fluctuate, and we would pick up the changing workload signatures. This is more complicated and will be our next step.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> IPython.core.display <span style="color:#f92672">import</span> display, HTML
display(HTML(<span style="color:#e6db74">&#34;&lt;style&gt;.container { width:100% !important; }&lt;/style&gt;&#34;</span>))
</code></pre></div><h1 id="todo">TODO</h1>
<p>Lots to do here.
<!-- raw HTML omitted --></p>
<ol>
<li>Configure Workload</li>
<li>Loop:
<ol>
<li>Configure SmartCache</li>
<li>Execute Workload</li>
<li>Collect Metrics</li>
<li>Register/Suggest</li>
</ol>
</li>
</ol>
<p>We will do it in 2 steps:</p>
<ol>
<li>Do it for a fixed workload without passing in any size/frequency estimators.
<!-- raw HTML omitted --></li>
<li>Add the estimators (will require upgrading the Optimizer to consume context features)</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> concurrent.futures <span style="color:#f92672">import</span> ThreadPoolExecutor
<span style="color:#f92672">import</span> os
<span style="color:#f92672">from</span> subprocess <span style="color:#f92672">import</span> Popen, CREATE_NEW_CONSOLE
<span style="color:#f92672">import</span> sys

<span style="color:#f92672">import</span> grpc
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> mlos.Grpc.BayesianOptimizerFactory <span style="color:#f92672">import</span> BayesianOptimizerFactory
<span style="color:#f92672">from</span> mlos.Logger <span style="color:#f92672">import</span> create_logger

<span style="color:#f92672">from</span> mlos.Examples.SmartCache <span style="color:#f92672">import</span> HitRateMonitor, SmartCache, SmartCacheWorkloadGenerator, SmartCacheWorkloadLauncher
<span style="color:#f92672">from</span> mlos.Mlos.SDK <span style="color:#f92672">import</span> MlosExperiment
<span style="color:#f92672">from</span> mlos.Optimizers.OptimizationProblem <span style="color:#f92672">import</span> OptimizationProblem, Objective
<span style="color:#f92672">from</span> mlos.Spaces <span style="color:#f92672">import</span> Point, SimpleHypergrid, ContinuousDimension

grpc_port <span style="color:#f92672">=</span> <span style="color:#ae81ff">50051</span>
mlos_python_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>abspath(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(os<span style="color:#f92672">.</span>getcwd(), <span style="color:#e6db74">&#34;..&#34;</span>, <span style="color:#e6db74">&#34;Mlos.Python&#34;</span>))
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">logger <span style="color:#f92672">=</span> create_logger(<span style="color:#e6db74">&#39;Optimizing Smart Cache&#39;</span>)
optimizer_service_grpc_channel <span style="color:#f92672">=</span> grpc<span style="color:#f92672">.</span>insecure_channel(f<span style="color:#e6db74">&#39;localhost:{grpc_port}&#39;</span>)
bayesian_optimizer_factory <span style="color:#f92672">=</span> BayesianOptimizerFactory(grpc_channel<span style="color:#f92672">=</span>optimizer_service_grpc_channel, logger<span style="color:#f92672">=</span>logger)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Optimization Problem</span>
<span style="color:#75715e">#</span>
optimization_problem <span style="color:#f92672">=</span> OptimizationProblem(
    parameter_space<span style="color:#f92672">=</span>SmartCache<span style="color:#f92672">.</span>parameter_search_space,
    objective_space<span style="color:#f92672">=</span>SimpleHypergrid(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;objectives&#34;</span>, dimensions<span style="color:#f92672">=</span>[ContinuousDimension(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hit_rate&#34;</span>, min<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, max<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)]),
    context_space<span style="color:#f92672">=</span>None,
    objectives<span style="color:#f92672">=</span>[Objective(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hit_rate&#34;</span>, minimize<span style="color:#f92672">=</span>False)]
)
optimizer <span style="color:#f92672">=</span> bayesian_optimizer_factory<span style="color:#f92672">.</span>create_remote_optimizer(optimization_problem<span style="color:#f92672">=</span>optimization_problem)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> os
os<span style="color:#f92672">.</span>getpid()
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
workload_launcher <span style="color:#f92672">=</span> SmartCacheWorkloadLauncher(logger<span style="color:#f92672">=</span>logger)
mlos_agent <span style="color:#f92672">=</span> workload_launcher<span style="color:#f92672">.</span>mlos_agent

<span style="color:#75715e"># Let&#39;s configure the SmartCacheWorkload</span>
<span style="color:#75715e">#</span>
mlos_agent<span style="color:#f92672">.</span>set_configuration(
    component_type<span style="color:#f92672">=</span>SmartCacheWorkloadGenerator,
    new_config_values<span style="color:#f92672">=</span>Point(
        workload_type<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;sequential_key_from_range&#39;</span>,
        sequential_key_from_range_config<span style="color:#f92672">=</span>Point(
            min<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
            range_width<span style="color:#f92672">=</span><span style="color:#ae81ff">2048</span>
        )
    )
)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Now finally we build the experiment.</span>
<span style="color:#75715e">#</span>
hit_rate_monitor <span style="color:#f92672">=</span> HitRateMonitor()
smart_cache_experiment <span style="color:#f92672">=</span> MlosExperiment(
    smart_component_types<span style="color:#f92672">=</span>[SmartCache],
    telemetry_aggregators<span style="color:#f92672">=</span>[hit_rate_monitor]
)
mlos_agent<span style="color:#f92672">.</span>start_experiment(smart_cache_experiment)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">num_iterations <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(num_iterations):
    mlos_agent<span style="color:#f92672">.</span>set_configuration(component_type<span style="color:#f92672">=</span>SmartCache, new_config_values<span style="color:#f92672">=</span>optimizer<span style="color:#f92672">.</span>suggest())
    hit_rate_monitor<span style="color:#f92672">.</span>reset()
    workload_launcher<span style="color:#f92672">.</span>start_workload(block<span style="color:#f92672">=</span>True)

    current_cache_config <span style="color:#f92672">=</span> mlos_agent<span style="color:#f92672">.</span>get_configuration(component_type<span style="color:#f92672">=</span>SmartCache)
    features_df <span style="color:#f92672">=</span> current_cache_config<span style="color:#f92672">.</span>to_pandas()
    hit_rate <span style="color:#f92672">=</span> hit_rate_monitor<span style="color:#f92672">.</span>get_hit_rate()
    objectives_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame({<span style="color:#e6db74">&#39;hit_rate&#39;</span>: [hit_rate]})
    optimizer<span style="color:#f92672">.</span>register(features_df, objectives_df)
    logger<span style="color:#f92672">.</span>info(f<span style="color:#e6db74">&#34;[{i+1}/{num_iterations}]current_config: {current_cache_config}, hit_rate: {hit_rate}, num_requests: {hit_rate_monitor._num_requests}&#34;</span>)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">hit_rate_monitor<span style="color:#f92672">.</span>_num_requests
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Clean up</span>
<span style="color:#75715e">#</span>
mlos_agent<span style="color:#f92672">.</span>stop_experiment(smart_cache_experiment)
mlos_globals<span style="color:#f92672">.</span>mlos_global_context<span style="color:#f92672">.</span>stop_clock()
mlos_agent<span style="color:#f92672">.</span>stop_all()

</code></pre></div></article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents"></nav>

 
    </aside>
    
  </main>

  
</body>

</html>












